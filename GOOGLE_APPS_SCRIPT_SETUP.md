# Google Apps Script セットアップガイド

## 📊 スプレッドシート準備

### ステップ1: スプレッドシートを開く

1. 以下のURLでスプレッドシートを開く：
   ```
   https://docs.google.com/spreadsheets/d/1MaCsDpwYOtNn8hqywq300hThzMIXOhPnkS6LvcUskuk/edit
   ```

### ステップ2: シート構成を確認

以下の3つのシートが必要です：

#### シート1: 研修生マスタ
| 研修生ID | 氏名 | ステータス |
|---------|------|----------|
| user01  | あなたの名前 | 進行中 |

#### シート2: 打刻記録
| 日付 | 研修生ID | 氏名 | 出勤時刻 | 退勤時刻 | 勤務時間 |
|------|---------|------|---------|---------|---------|
| (空) | (空) | (空) | (空) | (空) | (空) |

#### シート3: 課題完了記録
| 完了日時 | 研修生ID | 氏名 | アプリURL | 判定 |
|---------|---------|------|---------|------|
| (空) | (空) | (空) | (空) | (空) |

**⚠️ 重要:**
- シート名は **完全に一致** する必要があります
- ヘッダー行（1行目）は必須です
- データは2行目から記録されます

---

## 🔧 Apps Script セットアップ

### ステップ1: Apps Script エディタを開く

1. スプレッドシートを開く
2. メニューから **拡張機能** > **Apps Script** をクリック

### ステップ2: コードをコピー

1. 自動生成された `コード.gs` の内容を全て削除
2. `google-apps-script.js` の内容を全てコピー
3. Apps Script エディタに貼り付け
4. **保存** (💾 アイコン) をクリック

### ステップ3: プロジェクト名を変更（オプション）

1. 左上の「無題のプロジェクト」をクリック
2. 「勤怠管理アプリAPI」などに変更

### ステップ4: デプロイ

1. 右上の **デプロイ** > **新しいデプロイ** をクリック
2. **歯車アイコン** ⚙️ をクリック > **ウェブアプリ** を選択
3. 設定:
   - **説明**: 勤怠管理API v1
   - **次のユーザーとして実行**: **自分**
   - **アクセスできるユーザー**: **全員**
4. **デプロイ** をクリック
5. **アクセスを承認** をクリック
6. Googleアカウントを選択
7. **詳細** をクリック > **安全でないページに移動** をクリック
8. **許可** をクリック

### ステップ5: デプロイURLをコピー

デプロイ完了後、**ウェブアプリURL** が表示されます。

例:
```
https://script.google.com/macros/s/1PKd163hT62LrLT8cE0TsGiJIqGN9rTBLV_fP-zNU2Qdv5N8Zr4CbKue8/exec
```

このURLをコピーして保存してください。

---

## 🧪 テスト実行

### Apps Script エディタでテスト

1. エディタ上部の関数選択で **testClockIn** を選択
2. **実行** ボタン (▶️) をクリック
3. 実行ログを確認
4. スプレッドシートの「打刻記録」シートにデータが追加されていることを確認

同様に:
- **testClockOut** を実行して退勤記録をテスト
- **testTaskComplete** を実行して課題完了をテスト

### Webアプリとしてテスト（cURLコマンド）

ターミナルで以下を実行：

```bash
# 出勤テスト
curl -X POST "YOUR_DEPLOY_URL" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "clockIn",
    "userId": "user01",
    "userName": "テストユーザー",
    "date": "2025-11-29",
    "clockInTime": "09:00"
  }'

# 退勤テスト
curl -X POST "YOUR_DEPLOY_URL" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "clockOut",
    "userId": "user01",
    "userName": "テストユーザー",
    "date": "2025-11-29",
    "clockInTime": "09:00",
    "clockOutTime": "18:00",
    "workDuration": "9時間0分"
  }'
```

---

## 🔄 アプリとの連携

### すでに設定済み

`js/app.js` の以下の部分がすでに設定されています：

```javascript
const API_CONFIG = {
    LINE_NOTIFY_URL: '',
    SPREADSHEET_ID: '1MaCsDpwYOtNn8hqywq300hThzMIXOhPnkS6LvcUskuk',
    APPS_SCRIPT_URL: 'https://script.google.com/macros/s/1PKd163hT62LrLT8cE0TsGiJIqGN9rTBLV_fP-zNU2Qdv5N8Zr4CbKue8/exec'
};
```

### URLが変わった場合

デプロイURLが変わった場合は、`js/app.js` の `APPS_SCRIPT_URL` を更新してください。

---

## 🐛 トラブルシューティング

### エラー: シートが見つかりません

**原因**: シート名が正確に一致していない

**解決策**:
1. スプレッドシートのシート名を確認
2. 以下の名前と完全一致していることを確認:
   - `研修生マスタ`
   - `打刻記録`
   - `課題完了記録`

### エラー: 権限エラー

**原因**: Apps Scriptがスプレッドシートにアクセスできない

**解決策**:
1. Apps Script エディタで任意の関数を実行
2. 権限の確認を求められたら「許可」をクリック

### データが記録されない

**原因1**: デプロイURLが正しくない

**解決策**: `js/app.js` の `APPS_SCRIPT_URL` を確認

**原因2**: CORS エラー

**解決策**: `mode: 'no-cors'` が設定されているか確認（既に設定済み）

### 実行ログの確認方法

1. Apps Script エディタで **実行数** をクリック
2. 最近の実行ログを確認
3. エラーメッセージを確認

---

## 📝 データ確認

### スプレッドシートで確認

1. 各シートを開く
2. データが正しく記録されているか確認

### アプリから確認

1. アプリで出勤 > 退勤 > 課題完了を実行
2. スプレッドシートを確認
3. 各シートにデータが追加されていればOK

---

## 🔐 セキュリティ注意事項

- デプロイURLは公開されるため、機密情報は含めない
- 本番環境では「アクセスできるユーザー」を制限することを推奨
- 定期的にデプロイを更新してセキュリティを強化

---

**作成日**: 2025-11-29
**Apps Script プロジェクトID**: 1PKd163hT62LrLT8cE0TsGiJIqGN9rTBLV_fP-zNU2Qdv5N8Zr4CbKue8
