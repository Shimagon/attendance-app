# 勤怠管理PWAアプリ 仕様書

## 1. 概要

スマートフォンからワンタップで出退勤を打刻し、管理者のLINEグループに自動通知する勤怠管理PWAアプリケーション。
ホーム画面に追加することでネイティブアプリのように動作し、オフライン環境でも基本機能が利用可能。

## 2. 目的

- 従業員の勤怠打刻を簡易化し、打刻漏れを防止する
- 管理者がリアルタイムで勤怠状況を把握できるようにする
- スプレッドシートで勤怠データを一元管理する
- 課題完了時の報告フローを自動化する
- PWA化により、インストール不要でアプリライクな体験を提供する

## 3. 画面構成

### 3.1 初期設定画面（初回起動時のみ）
- ユーザー名入力フォーム
- 設定保存ボタン
- 利用規約・使い方の表示

### 3.2 メイン画面（ホーム画面）
- ヘッダー部
  - アプリタイトル
  - ユーザー名表示
  - 設定変更ボタン
- 打刻ボタンエリア
  - 出勤ボタン（大きなタップエリア）
  - 退勤ボタン（大きなタップエリア）
  - 課題完了報告ボタン
- ステータス表示エリア
  - 現在の勤務状態（未出勤/勤務中/退勤済み）
  - 出勤時刻表示
  - 勤務時間表示（リアルタイム更新）
- 本日の打刻履歴
  - 出勤時刻
  - 退勤時刻
  - 勤務時間

### 3.3 設定画面
- ユーザー名変更フォーム
- データリセットボタン
- バージョン情報表示

### 3.4 履歴画面
- 過去の打刻履歴一覧（直近30日分）
- 日付別の勤務時間表示
- フィルタ機能（月別）

## 4. 入出力仕様

### 4.1 入力

#### ユーザー入力
- ユーザー名（文字列、1-50文字）
- 打刻ボタンのタップ操作

#### システム入力
- 現在日時（デバイスの時刻）
- 位置情報（オプション：今後の拡張用）

### 4.2 出力

#### LINE通知（Messaging API経由）
**出勤時**
```
【出勤打刻】
氏名: {ユーザー名}
時刻: {YYYY/MM/DD HH:MM}
```

**退勤時**
```
【退勤打刻】
氏名: {ユーザー名}
時刻: {YYYY/MM/DD HH:MM}
勤務時間: {H時間M分}
```

**課題完了時**
```
【課題完了報告】
氏名: {ユーザー名}
時刻: {YYYY/MM/DD HH:MM}
アプリURL: {デプロイ先URL}
```

#### スプレッドシート記録（Google Apps Script経由）
| 日付 | ユーザー名 | 出勤時刻 | 退勤時刻 | 勤務時間 | イベント種別 | タイムスタンプ |
|------|-----------|---------|---------|---------|-------------|--------------|
| 2025/11/29 | 山田太郎 | 09:00 | 18:00 | 9時間0分 | 退勤 | 2025/11/29 18:00:00 |

#### ローカルストレージ保存
- ユーザー設定
- 打刻履歴
- 状態管理データ

## 5. 機能一覧

### 5.1 出勤打刻機能
- **トリガー**: 出勤ボタンタップ
- **処理内容**:
  1. 現在日時を取得
  2. localStorageに出勤時刻を保存
  3. LINE通知を送信
  4. スプレッドシートに記録
  5. UI状態を「勤務中」に更新
  6. 勤務時間のリアルタイム表示を開始
- **エラー処理**:
  - 既に出勤済みの場合は警告表示
  - 通信エラー時はローカル保存のみ行い、再送キューに追加

### 5.2 退勤打刻機能
- **トリガー**: 退勤ボタンタップ
- **処理内容**:
  1. 現在日時を取得
  2. 出勤時刻との差分から勤務時間を計算
  3. localStorageに退勤時刻と勤務時間を保存
  4. LINE通知を送信（勤務時間含む）
  5. スプレッドシートに記録
  6. UI状態を「退勤済み」に更新
  7. 勤務時間表示を確定
- **エラー処理**:
  - 出勤打刻がない場合は警告表示
  - 通信エラー時はローカル保存のみ行い、再送キューに追加

### 5.3 課題完了報告機能
- **トリガー**: 課題完了報告ボタンタップ
- **処理内容**:
  1. 確認ダイアログを表示
  2. アプリURLと完了時刻を取得
  3. LINE通知を送信
  4. 完了フラグをlocalStorageに保存
- **エラー処理**:
  - 通信エラー時は再送キューに追加

### 5.4 リアルタイム勤務時間表示機能
- **処理内容**:
  1. 出勤中は1分ごとに勤務時間を更新
  2. 「H時間M分」形式で表示
  3. タブが非アクティブでも計算継続

### 5.5 履歴管理機能
- **処理内容**:
  1. 直近30日分の打刻履歴を表示
  2. 日付降順でソート
  3. 各日の勤務時間集計
  4. localStorage容量制限を考慮した古いデータの自動削除

### 5.6 オフライン対応機能
- **処理内容**:
  1. Service Workerによるアプリケーションキャッシュ
  2. オフライン時は打刻データをlocalStorageに保存
  3. オンライン復帰時に未送信データを自動送信
  4. ネットワーク状態の表示

### 5.7 PWA機能
- **処理内容**:
  1. manifest.jsonによるインストール対応
  2. アイコン設定（複数サイズ対応）
  3. スプラッシュスクリーン表示
  4. スタンドアロンモードでの起動

### 5.8 設定管理機能
- **処理内容**:
  1. ユーザー名の変更
  2. 全データのリセット
  3. 設定のlocalStorage保存

## 6. 使用技術

### 6.1 フロントエンド

#### HTML5
- セマンティックHTML
- PWA用metaタグ
- manifest.json連携

#### CSS3
- レスポンシブデザイン（モバイルファースト）
- Flexbox / Grid Layout
- CSSカスタムプロパティ（CSS Variables）
- タッチフレンドリーなUI（最小タップエリア44px×44px）
- ダークモード対応（オプション）

#### JavaScript (ES6+)
- バニラJavaScript（フレームワークレス）
- localStorage API
- Fetch API
- Service Worker API
- Notification API（オプション）
- モジュール分割（ES Modules）

### 6.2 外部連携

#### LINE Messaging API
- メッセージ送信API（Push Message）
- Webhookエンドポイント（今後の拡張用）

#### Google Apps Script
- Webアプリケーション公開機能
- スプレッドシート書き込み
- doPost()メソッドによるデータ受信

### 6.3 PWA関連

#### Service Worker
- キャッシュ戦略: Cache First（静的リソース）
- ネットワーク戦略: Network First（API通信）

#### Web App Manifest
- name, short_name
- icons（192x192, 512x512）
- start_url
- display: standalone
- theme_color, background_color

## 7. データ構造（localStorage）

### 7.1 ユーザー設定
**キー**: `attendanceApp_userSettings`
```json
{
  "userName": "山田太郎",
  "isInitialized": true,
  "createdAt": "2025-11-29T09:00:00.000Z",
  "appVersion": "1.0.0"
}
```

### 7.2 本日の打刻状態
**キー**: `attendanceApp_todayAttendance`
```json
{
  "date": "2025-11-29",
  "clockInTime": "2025-11-29T09:00:00.000Z",
  "clockOutTime": "2025-11-29T18:00:00.000Z",
  "workDuration": 540,
  "status": "clocked_out"
}
```

**statusの値**:
- `not_clocked_in`: 未出勤
- `clocked_in`: 勤務中
- `clocked_out`: 退勤済み

### 7.3 打刻履歴
**キー**: `attendanceApp_history`
```json
[
  {
    "id": "1732867200000_clock_in",
    "date": "2025-11-29",
    "userName": "山田太郎",
    "eventType": "clock_in",
    "timestamp": "2025-11-29T09:00:00.000Z",
    "clockInTime": "2025-11-29T09:00:00.000Z",
    "clockOutTime": null,
    "workDuration": null,
    "synced": true
  },
  {
    "id": "1732899600000_clock_out",
    "date": "2025-11-29",
    "userName": "山田太郎",
    "eventType": "clock_out",
    "timestamp": "2025-11-29T18:00:00.000Z",
    "clockInTime": "2025-11-29T09:00:00.000Z",
    "clockOutTime": "2025-11-29T18:00:00.000Z",
    "workDuration": 540,
    "synced": true
  }
]
```

**eventTypeの値**:
- `clock_in`: 出勤
- `clock_out`: 退勤
- `task_completed`: 課題完了

### 7.4 未送信キュー
**キー**: `attendanceApp_pendingQueue`
```json
[
  {
    "id": "1732867200000_pending",
    "type": "line_notification",
    "payload": {
      "userName": "山田太郎",
      "eventType": "clock_in",
      "timestamp": "2025-11-29T09:00:00.000Z"
    },
    "retryCount": 0,
    "createdAt": "2025-11-29T09:00:00.000Z"
  }
]
```

### 7.5 課題完了フラグ
**キー**: `attendanceApp_taskCompleted`
```json
{
  "isCompleted": true,
  "completedAt": "2025-11-29T18:00:00.000Z",
  "reportedUrl": "https://example.com/attendance-app"
}
```

## 8. 非機能要件

### 8.1 パフォーマンス
- 初回読み込み時間: 3秒以内
- 打刻ボタン応答時間: 200ms以内
- オフライン時の動作: フル機能利用可能

### 8.2 セキュリティ
- HTTPS必須
- LINE Messaging API トークンの環境変数管理
- XSS対策（入力値のサニタイズ）

### 8.3 ユーザビリティ
- タッチターゲットサイズ: 最小44px×44px
- フォントサイズ: 最小14px
- カラーコントラスト比: WCAG AA準拠

### 8.4 ブラウザ対応
- iOS Safari 14以降
- Android Chrome 90以降
- PWAインストール機能対応

## 9. テスト項目

### 9.1 機能テスト

#### 出勤打刻機能
- [ ] 出勤ボタンをタップするとLINE通知が届く
- [ ] 出勤時刻がlocalStorageに正しく保存される
- [ ] スプレッドシートに出勤記録が追加される
- [ ] UI状態が「勤務中」に更新される
- [ ] 勤務時間のリアルタイム表示が開始される
- [ ] 既に出勤済みの場合、警告が表示される

#### 退勤打刻機能
- [ ] 退勤ボタンをタップすると勤務時間が正しく計算される
- [ ] 退勤ボタンをタップするとLINE通知が届く（勤務時間含む）
- [ ] 退勤時刻と勤務時間がlocalStorageに正しく保存される
- [ ] スプレッドシートに退勤記録が正しく記録される
- [ ] UI状態が「退勤済み」に更新される
- [ ] 出勤打刻がない場合、警告が表示される

#### 課題完了報告機能
- [ ] 課題完了ボタンをタップすると確認ダイアログが表示される
- [ ] 確認後、管理者に通知が届く（アプリURL含む）
- [ ] 完了フラグがlocalStorageに保存される
- [ ] LINE通知に正しいアプリURLが含まれる

#### PWA機能
- [ ] ブラウザでインストールプロンプトが表示される
- [ ] スマホのホーム画面に追加できる
- [ ] ホーム画面から起動するとスタンドアロンモードで動作する
- [ ] アプリアイコンが正しく表示される
- [ ] スプラッシュスクリーンが表示される

### 9.2 統合テスト

#### データ連携
- [ ] 出勤→退勤の一連の流れでデータが正しく記録される
- [ ] スプレッドシートとlocalStorageのデータが一致する
- [ ] LINE通知の内容が正確である

#### オフライン対応
- [ ] オフライン時でも打刻が可能
- [ ] オンライン復帰時に未送信データが自動送信される
- [ ] ネットワーク状態が正しく表示される

### 9.3 ユーザビリティテスト

- [ ] ボタンのタップエリアが十分な大きさである（最小44px×44px）
- [ ] フォントサイズが読みやすい（最小14px）
- [ ] 片手操作で主要機能が利用できる
- [ ] ローディング状態が適切に表示される

### 9.4 パフォーマンステスト

- [ ] 初回読み込み時間が3秒以内
- [ ] 打刻ボタンの応答時間が200ms以内
- [ ] リアルタイム勤務時間表示が正確に動作する

### 9.5 ブラウザ互換性テスト

- [ ] iOS Safariで正常に動作する
- [ ] Android Chromeで正常に動作する
- [ ] PWAインストール機能が両OSで動作する

## 10. 今後の拡張機能（オプション）

- 位置情報による打刻制限
- 顔認証機能
- 休憩時間の記録
- 残業申請機能
- 月次レポート自動生成
- 管理者ダッシュボード
- 複数拠点対応
- 打刻修正申請機能

---

**作成日**: 2025-11-29
**バージョン**: 1.0.0
**作成者**: システム開発チーム
